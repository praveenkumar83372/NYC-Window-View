name: NYC Window View 24-7

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v3

      - name: 2. Install FFmpeg and Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install supabase requests

      - name: 3. Build Vertical Playlist
        env:
          SUPABASE_URL: "https://ofqbyabbjpincectjdya.supabase.co"
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python - <<EOF
          import os
          from supabase import create_client
          
          url = os.environ.get("SUPABASE_URL")
          key = os.environ.get("SUPABASE_KEY")
          supabase = create_client(url, key)
          
          response = supabase.table("playlist").select("url").execute()
          
          if not response.data:
              print("No videos found!")
              exit(1)
              
          with open("playlist.txt", "w") as f:
              for row in response.data:
                  f.write(f"file '{row['url']}'\n")
          EOF

      - name: 4. The 2026 "Crystal Audio" FFmpeg Command
        run: |
          # FIX: Added -async 1 and -af "aresample=async=1000:min_hard_comp=0.100000:first_pts=0"
          # This forces the audio to stay perfectly aligned with the clock.
          ffmpeg -re -stream_loop -1 -f concat -safe 0 -protocol_whitelist file,http,https,tcp,tls -i playlist.txt \
          -vcodec libx264 -preset veryfast -tune zerolatency -crf 23 -maxrate 2500k -bufsize 5000k \
          -pix_fmt yuv420p -g 60 -vf "scale=720:1280:force_original_aspect_ratio=decrease,pad=720:1280:(ow-iw)/2:(oh-ih)/2" \
          -acodec aac -ar 44100 -b:a 128k -ac 2 \
          -af "aresample=async=1:min_comp=0.001:min_hard_comp=0.100000:first_pts=0" \
          -f flv rtmp://a.rtmp.youtube.com/live2/${{ secrets.STREAM_KEY }}
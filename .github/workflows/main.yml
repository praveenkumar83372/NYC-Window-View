name: NYC Window View 24-7

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # Restarts every 6 hours to prevent GitHub timeout

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v3

      - name: 2. Install FFmpeg & Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install supabase requests

      - name: 3. Start Dynamic Stream Engine
        env:
          SUPABASE_URL: "https://ofqbyabbjpincectjdya.supabase.co"
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          python - <<EOF
          import os
          import time
          import subprocess
          import requests
          from supabase import create_client

          # Initialize Supabase
          supabase = create_client(os.environ.get("SUPABASE_URL"), os.environ.get("SUPABASE_KEY"))
          stream_url = f"rtmp://a.rtmp.youtube.com/live2/{os.environ.get('STREAM_KEY')}"

          def get_playlist():
              """Fetch latest videos from Supabase"""
              response = supabase.table("playlist").select("url").execute()
              return [row['url'] for row in response.data] if response.data else []

          def stream_forever():
              print("ðŸš€ Starting Dynamic NYC Engine...")
              
              while True:
                  urls = get_playlist()
                  if not urls:
                      print("âš ï¸ No videos found. Waiting 30s...")
                      time.sleep(30)
                      continue

                  for video_url in urls:
                      print(f"ðŸŽ¥ Now Streaming: {video_url}")
                      
                      # POWERFUL FFmpeg COMMAND:
                      # -re: Read input at native frame rate (1.0x speed)
                      # -preset ultrafast: Lowest CPU usage for max stability
                      # -g 30: Force Keyframe every 1s to stop the grey screen
                      # -bufsize 20M: Massive buffer to eliminate pixelation
                      # -flvflags no_duration_filesize: Optimized for 24/7 live
                      
                      cmd = [
                          "ffmpeg", "-hide_banner", "-loglevel", "warning",
                          "-re", "-i", video_url,
                          "-c:v", "libx264", "-preset", "ultrafast", "-tune", "zerolatency",
                          "-profile:v", "baseline", "-level", "3.1", "-pix_fmt", "yuv420p",
                          "-vf", "scale=720:1280:force_original_aspect_ratio=decrease,pad=720:1280:(ow-iw)/2:(oh-ih)/2,format=yuv420p",
                          "-b:v", "3000k", "-maxrate", "3000k", "-minrate", "3000k", "-bufsize", "20M",
                          "-nal-hrd", "cbr", "-g", "30", "-keyint_min", "30",
                          "-c:a", "aac", "-ar", "44100", "-b:a", "128k", "-ac", "2",
                          "-f", "flv", "-flvflags", "no_duration_filesize", stream_url
                      ]
                      
                      # Execute FFmpeg for the single clip
                      process = subprocess.Popen(cmd)
                      process.wait() 
                      
                      # Tiny pause between clips to prevent YouTube from cutting the live
                      time.sleep(1) 
                  
                  print("ðŸ”„ Playlist finished. Fetching new updates from Supabase...")

          if __name__ == "__main__":
              stream_forever()
          EOF
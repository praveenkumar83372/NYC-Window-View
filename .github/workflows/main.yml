name: NYC 24-7 Infinite Engine

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # Essential: Starts a fresh runner every 6 hours

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Install FFmpeg & Python
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install supabase requests

      - name: 2. Start Infinite 24/7 Engine
        env:
          SUPABASE_URL: "https://ofqbyabbjpincectjdya.supabase.co"
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          python - <<EOF
          import os, time, subprocess
          from supabase import create_client

          # Initialize Supabase
          supabase = create_client(os.environ.get("SUPABASE_URL"), os.environ.get("SUPABASE_KEY"))
          stream_url = f"rtmp://a.rtmp.youtube.com/live2/{os.environ.get('STREAM_KEY')}"

          def get_urls():
              """Sync with Supabase for real-time playlist updates"""
              try:
                  response = supabase.table("playlist").select("url").execute()
                  return [row['url'] for row in response.data] if response.data else []
              except:
                  return []

          print("ðŸš€ Infinite Engine Active...")
          while True:
              urls = get_urls()
              if not urls:
                  time.sleep(30)
                  continue

              for video_url in urls:
                  # STABILITY FIXES:
                  # -level 4.1: Fixes the 'VBV buffer' crash from your logs
                  # -preset ultrafast: Ensures the stream stays at 1.0x speed
                  # -bufsize 15M: Prevents pixelation and VBV underflow
                  # -g 60: Forces a full image refresh every 2 seconds
                  
                  cmd = [
                      "ffmpeg", "-hide_banner", "-loglevel", "error",
                      "-re", "-i", video_url,
                      "-c:v", "libx264", "-preset", "ultrafast", "-tune", "zerolatency",
                      "-profile:v", "high", "-level", "4.1", "-pix_fmt", "yuv420p",
                      "-vf", "scale=720:1280:force_original_aspect_ratio=decrease,pad=720:1280:(ow-iw)/2:(oh-ih)/2,format=yuv420p",
                      "-b:v", "3000k", "-maxrate", "3000k", "-minrate", "3000k", "-bufsize", "15M",
                      "-nal-hrd", "cbr", "-g", "60", "-keyint_min", "60", "-sc_threshold", "0",
                      "-c:a", "aac", "-ar", "44100", "-b:a", "128k", "-ac", "2",
                      "-f", "flv", stream_url
                  ]
                  subprocess.run(cmd)
                  time.sleep(1) # Safety gap between videos
          EOF
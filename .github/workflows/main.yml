name: NYC Window View 24-7

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v3

      - name: 2. Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install supabase requests

      - name: 3. Download and Verify Videos
        env:
          SUPABASE_URL: "https://ofqbyabbjpincectjdya.supabase.co"
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python - <<EOF
          import os, requests
          from supabase import create_client
          supabase = create_client(os.environ.get("SUPABASE_URL"), os.environ.get("SUPABASE_KEY"))
          response = supabase.table("playlist").select("url").execute()
          if not response.data:
              exit(1)
          os.makedirs("videos", exist_ok=True)
          with open("inputs.txt", "w") as f:
              for i, row in enumerate(response.data):
                  path = f"videos/vid_{i}.mp4"
                  r = requests.get(row['url'], stream=True)
                  with open(path, 'wb') as v:
                      for chunk in r.iter_content(chunk_size=8192):
                          v.write(chunk)
                  f.write(f"{os.path.abspath(path)}\n")
          EOF

      - name: 4. The 100% Guaranteed Image Stream
        run: |
          # Build inputs from local files to prevent network drops
          INPUTS=""
          FILTER=""
          JOIN=""
          COUNT=0
          while read -r line; do
            INPUTS="$INPUTS -re -i $line"
            FILTER="$FILTER [$COUNT:v]scale=720:1280,setsar=1,format=yuv420p[v$COUNT]; [$COUNT:a]aresample=44100[a$COUNT];"
            JOIN="$JOIN [v$COUNT][a$COUNT]"
            COUNT=$((COUNT+1))
          done < inputs.txt

          while true; do
            echo "Forcing 2500k Bitrate - Fixing Grey Screen..."
            
            # THE FIXES FOR GREY SCREEN & 0 BITRATE:
            # 1. -b:v 2500k: Forces the recommended bitrate to stop the '0' error
            # 2. -preset ultrafast: Reduces CPU load so the encoder never stalls
            # 3. -g 30: Sends a full image every second to force the player to show the video
            # 4. -profile:v baseline: Most basic standard to ensure compatibility
            
            ffmpeg -hide_banner -loglevel warning \
              $INPUTS -filter_complex "$FILTER $JOIN concat=n=$COUNT:v=1:a=1[v][a]" \
              -map "[v]" -map "[a]" \
              -c:v libx264 -preset ultrafast -tune zerolatency \
              -profile:v baseline -level 3.1 -pix_fmt yuv420p \
              -b:v 2500k -maxrate 2500k -minrate 2500k -bufsize 5000k \
              -nal-hrd cbr -g 30 -keyint_min 30 -sc_threshold 0 \
              -c:a aac -ar 44100 -b:a 128k -ac 2 \
              -f flv rtmp://a.rtmp.youtube.com/live2/${{ secrets.STREAM_KEY }}
            
            echo "Stream restarting. Re-looping..."
            sleep 5
          done
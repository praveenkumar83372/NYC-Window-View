name: NYC Window View 24-7

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v3

      - name: 2. Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install supabase requests

      - name: 3. Build Playlist & Pre-Process
        env:
          SUPABASE_URL: "https://ofqbyabbjpincectjdya.supabase.co"
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python - <<EOF
          import os
          import requests
          from supabase import create_client
          
          url = os.environ.get("SUPABASE_URL")
          key = os.environ.get("SUPABASE_KEY")
          supabase = create_client(url, key)
          response = supabase.table("playlist").select("url").execute()
          
          if not response.data:
              exit(1)

          # We write the URLs to a file, but we will use a different FFmpeg method
          with open("list.txt", "w") as f:
              for row in response.data:
                  f.write(f"{row['url']}\n")
          EOF

      - name: 4. The 24/7 "Filter Concat" Master Command
        run: |
          # We use a shell script to build a complex filter that decodes every video properly
          # This prevents the "No start code found" and "DTS out of order" errors.
          
          URLS=$(cat list.txt)
          INPUTS=""
          FILTER=""
          COUNT=0
          
          for URL in $URLS; do
            INPUTS="$INPUTS -i $URL"
            FILTER="$FILTER [$COUNT:v]scale=720:1280:force_original_aspect_ratio=decrease,pad=720:1280:(ow-iw)/2:(oh-ih)/2,setsar=1[v$COUNT];"
            AUDIO_FILTER="$AUDIO_FILTER [$COUNT:a]aresample=44100[a$COUNT];"
            CONCAT_V="$CONCAT_V [v$COUNT]"
            CONCAT_A="$CONCAT_A [a$COUNT]"
            COUNT=$((COUNT+1))
          done

          # This is the "Magic" command that merges everything into one stream
          until ffmpeg -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
            $INPUTS -filter_complex "$FILTER $AUDIO_FILTER $CONCAT_V $CONCAT_A concat=n=$COUNT:v=1:a=1[v][a]" \
            -map "[v]" -map "[a]" \
            -c:v libx264 -preset veryfast -tune zerolatency -b:v 2500k -maxrate 2500k -bufsize 5000k \
            -g 60 -pix_fmt yuv420p -c:a aac -ar 44100 -b:a 128k -ac 2 \
            -f flv rtmp://a.rtmp.youtube.com/live2/${{ secrets.STREAM_KEY }}; do
            echo "Stream crashed. Restarting in 5 seconds..."
            sleep 5
          done
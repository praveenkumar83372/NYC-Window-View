name: 24-7 YouTube Live Stream

on:
  workflow_dispatch:

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install FFmpeg & dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install supabase requests

      - name: Fetch playlist from Supabase
        env:
          SUPABASE_URL: "https://ofqbyabbjpincectjdya.supabase.co"
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python - <<EOF
          import os
          from supabase import create_client
          supabase = create_client(os.environ["SUPABASE_URL"], os.environ["SUPABASE_KEY"])
          res = supabase.table("playlist").select("url").execute()
          if not res.data: exit(1)
          with open("list.txt","w") as f:
            for r in res.data: f.write(r["url"] + "\n")
          EOF

      - name: Start 24/7 stream
        run: |
          while true; do
            echo "Starting live stream..."
            URLS=$(cat list.txt)
            INPUTS=""
            FILTERS=""
            MAP=""
            i=0

            for URL in $URLS; do
              INPUTS="$INPUTS -re -i $URL"
              FILTERS="$FILTERS [$i:v]scale=720:1280,format=yuv420p,setsar=1[v$i];"
              FILTERS="$FILTERS [$i:a]aresample=44100,pan=stereo|c0=c0|c1=c1[a$i];"
              MAP="$MAP[v$i][a$i]"
              i=$((i+1))
            done

            ffmpeg -hide_banner -loglevel warning \
              $INPUTS -filter_complex "$FILTERS $MAP concat=n=$i:v=1:a=1[v][a]" \
              -map "[v]" -map "[a]" \
              -c:v libx264 -preset veryfast -tune zerolatency \
              -profile:v main -level 4.1 -pix_fmt yuv420p \
              -b:v 4000k -maxrate 4000k -minrate 4000k -bufsize 8000k -nal-hrd cbr -g 30 \
              -c:a aac -ar 44100 -b:a 128k -ac 2 \
              -f flv rtmp://a.rtmp.youtube.com/live2/${{ secrets.STREAM_KEY }}

            echo "Stream stopped. Restarting in 5 seconds..."
            sleep 5
          done

name: NYC Walking Peak-Time Streamer

on:
  workflow_dispatch:
  schedule:
    - cron: '0 13,21 * * *'

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Install FFmpeg & Python
        run: |
          sudo apt-get update && sudo apt-get install -y ffmpeg
          pip install supabase requests

      - name: Center-Crop & Stream 9:16
        env:
          SUPABASE_URL: "https://ofqbyabbjpincectjdya.supabase.co"
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
          TG_TOKEN: "8388212435:AAHuhQ7XSf4eJKxswzyW0yk5ALEYV-x4I7U"
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python - <<EOF
          import os, subprocess, requests
          from supabase import create_client
          supabase = create_client(os.environ.get("SUPABASE_URL"), os.environ.get("SUPABASE_KEY"))
          stream_url = f"rtmp://a.rtmp.youtube.com/live2/{os.environ.get('STREAM_KEY')}"
          
          # Fetch newest walking video
          res = supabase.table("playlist").select("url").order("id", desc=True).limit(1).execute()
          if res.data:
              video_url = res.data[0]['url']
              r = requests.get(video_url, stream=True)
              with open("walk.mp4", 'wb') as f:
                  for chunk in r.iter_content(chunk_size=8192): f.write(chunk)
              
              # CROP LOGIC: Extracts center 9:16 from 16:9
              cmd = ["ffmpeg", "-re", "-i", "walk.mp4", "-vf", "crop=ih*9/16:ih,scale=720:1280,format=yuv420p", "-c:v", "libx264", "-preset", "ultrafast", "-b:v", "3500k", "-f", "flv", stream_url]
              subprocess.run(cmd)
              
              # Delete from playlist after streaming
              supabase.table("playlist").delete().eq("url", video_url).execute()
          EOF
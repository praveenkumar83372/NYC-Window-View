name: NYC Walking Peak-Time Streamer

on:
  workflow_dispatch:
  schedule:
    - cron: '0 13,21 * * *' # 1PM and 9PM UTC for US Peak

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: Install FFmpeg & Python
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install supabase requests

      - name: Center-Crop & Stream
        env:
          SUPABASE_URL: "https://ofqbyabbjpincectjdya.supabase.co"
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
          TG_TOKEN: "8388212435:AAHuhQ7XSf4eJKxswzyW0yk5ALEYV-x4I7U"
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python - <<EOF
          import os, time, subprocess, requests
          from supabase import create_client

          supabase = create_client(os.environ.get("SUPABASE_URL"), os.environ.get("SUPABASE_KEY"))
          stream_url = f"rtmp://a.rtmp.youtube.com/live2/{os.environ.get('STREAM_KEY')}"
          
          def send_tg(msg):
              requests.post(f"https://api.telegram.org/bot{os.environ.get('TG_TOKEN')}/sendMessage", 
                            data={"chat_id": os.environ.get('TG_CHAT_ID'), "text": msg})

          # 1. Check for videos
          res = supabase.table("playlist").select("url").execute()
          urls = [r['url'] for r in res.data] if res.data else []
          
          if not urls:
              send_tg("âš ï¸ No videos in playlist. Add more via Telegram!")
              exit()

          # 2. Download locally for stability
          if not os.path.exists('vids'): os.makedirs('vids')
          with open("list.txt", "w") as f:
              for i, url in enumerate(urls):
                  path = f"vids/v{i}.mp4"
                  r = requests.get(url, stream=True)
                  with open(path, 'wb') as v:
                      for chunk in r.iter_content(chunk_size=8192): v.write(chunk)
                  f.write(f"file '{os.path.abspath(path)}'\n")

          # 3. Stream with Center Crop
          # crop=ih*9/16:ih removes the sides to make it vertical
          cmd = [
              "ffmpeg", "-re", "-f", "concat", "-safe", "0", "-i", "list.txt",
              "-c:v", "libx264", "-preset", "ultrafast", "-tune", "zerolatency",
              "-vf", "crop=ih*9/16:ih,scale=720:1280,format=yuv420p",
              "-b:v", "3500k", "-maxrate", "3500k", "-bufsize", "14M",
              "-g", "60", "-c:a", "aac", "-b:a", "128k", "-f", "flv", stream_url
          ]
          
          send_tg(f"ðŸŽ¥ NYC Peak Stream LIVE now with {len(urls)} walking videos!")
          subprocess.run(cmd, timeout=42900) # Safety stop at 11h 55m
          
          # 4. Cleanup Database
          supabase.table("playlist").delete().neq("url", "void").execute()
          send_tg("âœ… Stream finished. Playlist cleared.")
          EOF
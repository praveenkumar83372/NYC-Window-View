name: NYC Window View 24-7

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v3

      - name: 2. Install FFmpeg and Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install supabase requests

      - name: 3. Download Videos and Build Playlist
        env:
          SUPABASE_URL: "https://ofqbyabbjpincectjdya.supabase.co"
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python - <<EOF
          import os, requests
          from supabase import create_client
          
          url = os.environ.get("SUPABASE_URL")
          key = os.environ.get("SUPABASE_KEY")
          supabase = create_client(url, key)
          response = supabase.table("playlist").select("url").execute()
          
          if not response.data:
              print("No videos found in Supabase")
              exit(1)
          
          os.makedirs("videos", exist_ok=True)
          with open("list.txt", "w") as f:
              for i, row in enumerate(response.data):
                  video_url = row['url']
                  local_filename = f"videos/video_{i}.mp4"
                  print(f"Downloading {video_url}...")
                  
                  # Download to local disk to prevent 'Stream ends prematurely'
                  r = requests.get(video_url, stream=True)
                  with open(local_filename, 'wb') as vid:
                      for chunk in r.iter_content(chunk_size=8192):
                          vid.write(chunk)
                  
                  f.write(f"file '{os.path.abspath(local_filename)}'\n")
          EOF

      - name: 4. The 1x Speed "Local Disk" Master Stream
        run: |
          # The while loop ensures that if the playlist ends, it starts again immediately
          while true; do
            echo "Starting NYC Stream from Local Disk (Prevents Corrupt Packets)..."
            
            # THE "STABILITY" FIXES:
            # 1. Reading from LOCAL list.txt: Removes 'Packet corrupt' from network drops.
            # 2. -re: Forces 1x speed to match real-time heartbeat.
            # 3. -stream_loop -1: Tells FFmpeg to loop the entire playlist forever.
            # 4. -f concat: Glues the local files together seamlessly.
            
            ffmpeg -hide_banner -loglevel warning \
              -re -f concat -safe 0 -stream_loop -1 -i list.txt \
              -c:v libx264 -preset veryfast -tune zerolatency \
              -profile:v high -level 4.2 -pix_fmt yuv420p \
              -b:v 4500k -maxrate 4500k -bufsize 9000k \
              -g 60 -keyint_min 60 -sc_threshold 0 \
              -c:a aac -ar 44100 -b:a 128k -ac 2 \
              -f flv rtmp://a.rtmp.youtube.com/live2/${{ secrets.STREAM_KEY }}
            
            echo "FFmpeg crashed or closed. Restarting in 5 seconds..."
            sleep 5
          done
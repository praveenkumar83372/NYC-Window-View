import os, time, subprocess, requests
from supabase import create_client

# Connection Setup
supabase = create_client(os.environ.get("SUPABASE_URL"), os.environ.get("SUPABASE_KEY"))
stream_url = f"rtmp://a.rtmp.youtube.com/live2/{os.environ.get('STREAM_KEY')}"

def get_latest_video():
    """Gets the single newest video added from Telegram"""
    response = supabase.table("playlist").select("url").order("id", desc=True).limit(1).execute()
    return response.data[0]['url'] if response.data else None

video_url = get_latest_video()

if video_url:
    local_file = "current_walk.mp4"
    print(f"üì• Downloading Walking Video: {video_url}")
    
    # Download locally to prevent 'Broken Pipe' or 'NAL' errors
    r = requests.get(video_url, stream=True)
    with open(local_file, 'wb') as f:
        for chunk in r.iter_content(chunk_size=8192):
            f.write(chunk)

    print("üé• Starting Vertical 9:16 Walking Live...")
    
    # THE SIMPLIFIED CROP COMMAND
    # -i current_walk.mp4: Plays the one downloaded file.
    # crop=ih*9/16:ih: Cuts the 16:9 sides to fit the 9:16 center.
    
    cmd = [
        "ffmpeg", "-hide_banner", "-re", 
        "-i", local_file,
        "-c:v", "libx264", "-preset", "ultrafast", "-tune", "zerolatency",
        "-profile:v", "high", "-level", "4.1", "-pix_fmt", "yuv420p",
        "-vf", "crop=ih*9/16:ih,scale=720:1280,format=yuv420p",
        "-b:v", "3500k", "-maxrate", "3500k", "-bufsize", "14M",
        "-g", "60", "-c:a", "aac", "-b:a", "128k",
        "-f", "flv", stream_url
    ]
    
    # Run until the video ends naturally
    subprocess.run(cmd)
    
    # Clean up
    os.remove(local_file)
    print("‚úÖ Video finished. Stream closed.")
else:
    print("‚ùå No video found in playlist.")
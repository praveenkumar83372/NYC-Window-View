name: NYC Window View 24-7

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # Auto-restarts every 6 hours to stay within GitHub limits

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v3

      - name: 2. Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install supabase requests

      - name: 3. Build Playlist
        env:
          SUPABASE_URL: "https://ofqbyabbjpincectjdya.supabase.co"
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python - <<EOF
          import os
          from supabase import create_client
          url = os.environ.get("SUPABASE_URL")
          key = os.environ.get("SUPABASE_KEY")
          supabase = create_client(url, key)
          response = supabase.table("playlist").select("url").execute()
          if not response.data:
              exit(1)
          with open("list.txt", "w") as f:
              for row in response.data:
                  f.write(f"{row['url']}\n")
          EOF

      - name: 4. The Crystal HD 1x Master Stream
        run: |
          # 1. PRE-CONSTRUCT THE FILTER
          # We interleave [v][a] for every input to ensure perfect sync
          URLS=$(cat list.txt)
          INPUTS=""
          FILTER_PARTS=""
          CONCAT_MAP=""
          COUNT=0

          for URL in $URLS; do
            # -re BEFORE every -i forces the 1x real-time speed you need
            INPUTS="$INPUTS -re -i $URL"
            FILTER_PARTS="$FILTER_PARTS [$COUNT:v]scale=720:1280,format=yuv420p,setsar=1[v$COUNT];"
            FILTER_PARTS="$FILTER_PARTS [$COUNT:a]aresample=44100,pan=stereo|c0=c0|c1=c1[a$COUNT];"
            CONCAT_MAP="$CONCAT_MAP[v$COUNT][a$COUNT]"
            COUNT=$((COUNT+1))
          done

          # 2. THE INFINITE BROADCAST LOOP
          while true; do
            echo "Starting Ultra-Clear NYC Stream at 1x Speed..."
            
            # THE CRITICAL QUALITY FIXES:
            # -b:v 6000k / -minrate 6000k / -maxrate 6000k: Forces Constant Bitrate (CBR) for clear images.
            # -bufsize 12000k: Prevents the 'broken block' pixels (VBV Underflow).
            # -preset slow: Spends more CPU to make every detail in NYC sharp.
            # -level 4.2: Unlocks high-performance encoding for 720x1280.
            
            ffmpeg -hide_banner -loglevel warning \
              -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 5 \
              $INPUTS -filter_complex "$FILTER_PARTS $CONCAT_MAP concat=n=$COUNT:v=1:a=1[v][a]" \
              -map "[v]" -map "[a]" \
              -c:v libx264 -preset slow -tune zerolatency \
              -profile:v high -level 4.2 -pix_fmt yuv420p \
              -b:v 6000k -maxrate 6000k -minrate 6000k -bufsize 12000k \
              -nal-hrd cbr -g 60 -c:a aac -ar 44100 -b:a 128k -ac 2 \
              -af "aresample=async=1000:min_hard_comp=0.1" \
              -f flv rtmp://a.rtmp.youtube.com/live2/${{ secrets.STREAM_KEY }}
            
            echo "Playlist cycle finished or connection reset. Looping back in 5 seconds..."
            sleep 5
          done
name: NYC 24-7 Shielded Engine

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # Cycles runners every 6 hours

jobs:
  stream:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Install FFmpeg & Python
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install supabase requests

      - name: 2. Start Shielded 24/7 Engine
        env:
          SUPABASE_URL: "https://ofqbyabbjpincectjdya.supabase.co"
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          python - <<EOF
          import os, time, subprocess, requests
          from supabase import create_client

          supabase = create_client(os.environ.get("SUPABASE_URL"), os.environ.get("SUPABASE_KEY"))
          stream_url = f"rtmp://a.rtmp.youtube.com/live2/{os.environ.get('STREAM_KEY')}"

          def get_urls():
              try:
                  response = supabase.table("playlist").select("url").execute()
                  return [row['url'] for row in response.data] if response.data else []
              except Exception as e:
                  print(f"DB Error: {e}")
                  return []

          print("ðŸš€ Shielded Engine Starting...")
          while True:
              urls = get_urls()
              if not urls:
                  time.sleep(30)
                  continue

              for video_url in urls:
                  local_filename = "temp_video.mp4"
                  print(f"ðŸ“¥ Downloading to local disk: {video_url}")
                  
                  # DOWNLOAD TO LOCAL DISK FIRST (Prevents 'Broken pipe')
                  try:
                      r = requests.get(video_url, stream=True, timeout=30)
                      with open(local_filename, 'wb') as f:
                          for chunk in r.iter_content(chunk_size=8192):
                              f.write(chunk)
                  except Exception as e:
                      print(f"Download failed: {e}")
                      continue

                  print(f"ðŸŽ¥ Now Streaming from local disk...")
                  # STABILITY SETTINGS:
                  # -level 4.1: Supports the buffer without crashing
                  # -bufsize 14M: Prevents pixelation
                  # -g 60: Keyframe every 2 seconds for YouTube health
                  cmd = [
                      "ffmpeg", "-hide_banner", "-loglevel", "error",
                      "-re", "-i", local_filename,
                      "-c:v", "libx264", "-preset", "ultrafast", "-tune", "zerolatency",
                      "-profile:v", "high", "-level", "4.1", "-pix_fmt", "yuv420p",
                      "-vf", "scale=720:1280:force_original_aspect_ratio=decrease,pad=720:1280:(ow-iw)/2:(oh-ih)/2,format=yuv420p",
                      "-b:v", "3000k", "-maxrate", "3000k", "-minrate", "3000k", "-bufsize", "14M",
                      "-nal-hrd", "cbr", "-g", "60", "-keyint_min", "60", "-sc_threshold", "0",
                      "-c:a", "aac", "-ar", "44100", "-b:a", "128k", "-ac", "2",
                      "-f", "flv", stream_url
                  ]
                  subprocess.run(cmd)
                  
                  if os.path.exists(local_filename):
                      os.remove(local_filename)
                  
                  time.sleep(1) # Gap for YouTube ingest
          EOF